<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">
  <Import Project="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).tasks" Condition="Exists('$(MSBuildThisFileDirectory)$(MSBuildThisFileName).tasks')"/>

  <Target Name="ConvertProjectRefToNugetPackage">
    <ConvertProjectRefToNugetPackage SolutionDir="$(SolutionDir)" Projects="$(MSBuildProjectFile)" />
  </Target>

  <Target Name="ResolveDependants">
    <ResolveDependants DependecyProject="$(MSBuildProjectFile)"
                       AllProjects="@(AllProjects)">
      <Output TaskParameter="DependantProjectsBuildOrdered" ItemName="ProjectBuildOrder" />
    </ResolveDependants>
  </Target>

  <!-- Upload built nuget package to version repo -->
  <Target Name="UploadNugetPackage" AfterTargets="CreateNugetPackage" Condition="'$(UploadNugetPackage.ToLower())'=='true' And '$(BuildNugetPackage.ToLower())'=='true'">
    <ItemGroup>
      <MyNugetPackages Include="$(NugetBuildFolder)$(MSBuildProjectName).*.nupkg" />
    </ItemGroup>
    <Exec Command='"$(NugetToolPath)\Nuget.exe" add "%(MyNugetPackages.FullPath)" -ConfigFile "$(NugetConfig)" -Source "$(NugetSource)"'/>
  </Target>

  <!-- Create .nuspec file if missing -->
  <Target Name="EnsureNugetSpec" AfterTargets="Build" Condition="'$(BuildNugetPackage.ToLower())'=='true' And !Exists('$(NuSpecPath)')">
    <PropertyGroup>
      <NuspecIn Condition="'$(MSBuildProjectExtension)'=='.vcxproj' Or '$(MSBuildProjectExtension)'=='.vcproj'">$(MSBuildThisFileDirectory)\NativeProject.nuspec.xml</NuspecIn>
      <NuspecIn Condition="'$(MSBuildProjectExtension)'=='.csproj' Or '$(MSBuildProjectExtension)'=='.vbproj' Or '$(CLRSupport)'=='true'">$(MSBuildThisFileDirectory)\NetProject.nuspec.xml</NuspecIn>
    </PropertyGroup>
    <XslTransformation XmlInputPaths="$(NuspecIn)" XslInputPath="$(MSBuildThisFileDirectory)Nuspec.xslt" OutputPaths="$(NuSpecPath)" Parameters="&lt;Parameter Name='packagesConfigPath' Value='$(MSBuildProjectDirectory)\packages.config'/&gt;" UseTrustedSettings="true"/>
  </Target>

  <!-- Pack nuget with parameters -->
  <ItemGroup>
    <NugetPackProperty Include="Configuration=$(Configuration)"/>
    <NugetPackProperty Include="id=$(MSBuildProjectName)"/>
    <NugetPackProperty Include="title=$(NugetManufacturer) $(MSBuildProjectName)"/>
    <NugetPackProperty Include="author=$(NugetManufacturer)"/>
    <NugetPackProperty Include="projectUrl=$(MSBuildProjectName)"/>
    <NugetPackProperty Include="description=$(NugetManufacturer) $(MSBuildProjectName)"/>
    <NugetPackProperty Include="OutDir=$(OutDir)"/>
    <NugetPackProperty Include="IntDir=$(IntDir)"/>
    <NugetPackProperty Include="RootDir=$(SolutionDir)"/>
    <NugetPackProperty Include="ProjectName=$(MSBuildProjectName)"/>
    <NugetPackProperty Include="MyDir=$(MSBuildThisFileDirectory)\"/>
  </ItemGroup>

  <Target Name="CreateNugetPackage" AfterTargets="EnsureNugetSpec" Condition="'$(BuildNugetPackage.ToLower())'=='true'">
    <Copy DestinationFiles="$(IntDir)$(MSBuildProjectName).props" SourceFiles="$(MSBuildThisFileDirectory)\native-nuget-targets.xml" Condition="'$(MSBuildProjectExtension)'=='.vcxproj'" />
    <Copy DestinationFiles="$(IntDir)$(MSBuildProjectName).props" SourceFiles="$(MSBuildThisFileDirectory)\net-nuget-targets.xml" Condition="'$(MSBuildProjectExtension)'!='.vcxproj'" />
    <NuGetPack File="$(NuSpecPath)" OutputDirectory="$(NugetBuildFolder)" Version="$(NugetVersion)" Suffix="$(NuspecVersionSuffix)" Build="false" Properties="@(NugetPackProperty);VersionTags=@(VersionTag->'%(Identity)', ' ')" IncludeReferencedProjects="false" BasePath="$(MSBuildProjectDirectory)" ExcludeEmptyDirectories="false" ToolPath="$(NugetToolPath)"/>
  </Target>
</Project>