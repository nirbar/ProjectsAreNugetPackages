<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildThisFileDirectory)..\build\ProjectsAreNugetPackages.targets"/>

  <!-- ==========================================================
    Migration steps:
    -# Install ProjectsAreNugetPackages to all projects
    -# Execute target 'OneTimeInit'
    -# Create/Update files:
      - TidyBuild.custom.props
      - Nuget.Config
    -# Execute regular build
      - Should upload packages to local nuget repository
    -# Execute target 'OneTime_ConvertProjectRefToNugetPackage'
    
    Routine builds:
    -# Execute target 'Build'
      - Set 'TargetProject' property from command line
      - Set 'NuspecVersion' property from command line
      - Specify multi-processor flag to enable parallel builds.
    -# Execute target 'Upload' to add packages to Nuget repository
      - Set 'TargetProject' property from command line
      - Set 'NuspecVersion' property from command line
      - Specify multi-processor flag to enable parallel uploads.
       ==========================================================-->

  <ItemGroup>
    <CsProjects Include="..\**\*.csproj">
      <Properties>Configuration=Release;Platform=Any CPU</Properties>
    </CsProjects>
    <VcxProjects Include="..\**\*.vcxproj">
      <Properties>Configuration=Release;Platform=Win32</Properties>
    </VcxProjects>
  </ItemGroup>
  <ItemGroup>
    <AllProjects Include="@(CsProjects);@(VcxProjects)"/>
  </ItemGroup>
  
  <!-- Let projects override properties, exclude projects from build etc. -->    
  <Import Project="..\**\BuildAll.props"/>

  <PropertyGroup>
    <TargetProject>..\ConsoleApplication1\ConsoleApplication1.vcxproj</TargetProject>
  </PropertyGroup>

  <!-- Build in batches defined by ParallelBuildLevel metadata created by ResolveDependants task -->
  <Target Name="Build" DependsOnTargets="_ResolveBuildOrder" Inputs="@(ProjectBuildOrder)" Outputs="%(ParallelBuildLevel)\NeverExists">
    <Exec Command='"$(MSBuildBinPath)\MSBuild.exe" "%(ProjectBuildOrder.FullPath)" "/Property:%(ProjectBuildOrder.Properties)" /Target:NugetInstallUpdate' />
    <MSBuild Projects="@(ProjectBuildOrder)" Targets="Rebuild" BuildInParallel="true"/>
  </Target>

  <Target Name="_ResolveDependecyProjects">
    <ConvertToAbsolutePath Paths="$(TargetProject)">
      <Output TaskParameter="AbsolutePaths" PropertyName="TargetProjectAbsolute"/>
    </ConvertToAbsolutePath>
    <ItemGroup>
      <DependecyProject Include="@(AllProjects)" Condition="'%(AllProjects.FullPath)'=='$(TargetProjectAbsolute)'"/>
    </ItemGroup>
    <Message Text="Target Projects: @(DependecyProject)" Importance="low"/>
  </Target>

  <Target Name="_ResolveBuildOrder" DependsOnTargets="_ResolveDependecyProjects">
    <ResolveDependants DependecyProject="@(DependecyProject)" AllProjects="@(AllProjects)" PackageIdPrefix="HEX.">
      <Output TaskParameter="DependantProjectsBuildOrdered" ItemName="ProjectBuildOrder" />
    </ResolveDependants>
    <Message Text="Projects: @(AllProjects)" Importance="low"/>
    <Message Text="Project parallel build in step %(ProjectBuildOrder.ParallelBuildLevel): @(ProjectBuildOrder)"/>
  </Target>

  <!-- After successful build: upload Nuget packages -->
  <Target Name="Upload" DependsOnTargets="_ResolveBuildOrder" Inputs="@(ProjectBuildOrder)" Outputs="%(ParallelBuildLevel)\NeverExists">
    <MSBuild Projects="@(ProjectBuildOrder)" Targets="UploadNugetPackage" BuildInParallel="true" />
  </Target>
  
  <Target Name="OneTime_ConvertProjectRefToNugetPackage">
    <ConvertProjectRefToNugetPackage Projects="@(AllProjects)" 
                                     AllProjects="@(AllProjects)" 
                                     SolutionDir="$(MSBuildThisFileDirectory)..\" 
                                     PackageIdPrefix="Local."
                                     PackageVersion="10.0.0-local"/>
  </Target>

</Project>